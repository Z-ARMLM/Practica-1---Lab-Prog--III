<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Electoral - Admin</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { min-height: 100vh; background: white; border-right: 1px solid #dee2e6; transition: all 0.3s; }
        .sidebar .nav-link { color: #6c757d; padding: 12px 20px; font-weight: 500; border-radius: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
        .sidebar .nav-link:hover { background-color: #f8f9fa; color: #0d6efd; }
        .sidebar .nav-link.active { background-color: #e7f1ff; color: #0d6efd; font-weight: 600; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); transition: transform 0.2s; margin-bottom: 20px; }
        .card-header { background: white; border-bottom: 1px solid #f0f0f0; font-weight: 600; border-radius: 12px 12px 0 0 !important; }
        .survey-card { border-left: 4px solid transparent; }
        .survey-card.politica { border-left-color: #0d6efd; }
        .survey-card.comercial { border-left-color: #198754; }
        .survey-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .view-section { display: none; }
        .view-section.active { display: block; }
        .form-floating > label { left: 0; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="d-none">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 fw-bold text-muted">Sincronizando datos...</p>
    </div>

    <!-- ================= VISTA: ADMIN PANEL ================= -->
    <div id="view-admin" class="view-section">
        <div class="d-flex flex-column flex-lg-row">
            <!-- Sidebar -->
            <div class="sidebar p-3 d-flex flex-column" style="width: 280px; flex-shrink: 0;">
                <div class="d-flex align-items-center mb-4 px-2 py-2">
                    <div class="bg-primary text-white rounded p-2 me-2"><i class="bi bi-box-seam-fill"></i></div>
                    <span class="fs-5 fw-bold text-dark">Plataforma</span>
                </div>
                
                <ul class="nav flex-column mb-auto">
                    <li><a href="#" onclick="app.adminRouter('dashboard')" class="nav-link active" id="nav-dashboard"><i class="bi bi-bar-chart-line"></i> Resultados</a></li>
                    <li><a href="#" onclick="app.adminRouter('participants')" class="nav-link" id="nav-participants"><i class="bi bi-people"></i> Participantes</a></li>
                    <li><a href="#" onclick="app.adminRouter('surveys')" class="nav-link" id="nav-surveys"><i class="bi bi-file-earmark-text"></i> Encuestas</a></li>
                    <li><a href="#" onclick="app.adminRouter('invites')" class="nav-link" id="nav-invites"><i class="bi bi-send"></i> Invitaciones</a></li>
                </ul>
                
                <div class="mt-auto pt-4 border-top">
                    <button onclick="window.location.href = window.location.pathname" class="btn btn-outline-danger w-100 btn-sm mb-2"><i class="bi bi-box-arrow-left"></i> Cerrar Sesión</button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="flex-fill p-4 bg-light overflow-auto" style="height: 100vh;">
                
                <!-- 1. DASHBOARD -->
                <div id="admin-dashboard" class="admin-section">
                    <h2 class="fw-bold mb-4 text-dark">Panel de Resultados</h2>
                    
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1">TOTAL PARTICIPANTES</p>
                                        <h2 class="fw-bold mb-0" id="stat-total">0</h2>
                                    </div>
                                    <div class="bg-soft-primary p-3 rounded-circle text-primary bg-opacity-10"><i class="bi bi-people fs-4"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1">VOTOS RECIBIDOS</p>
                                        <h2 class="fw-bold mb-0 text-success" id="stat-votes">0</h2>
                                    </div>
                                    <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success"><i class="bi bi-check-lg fs-4"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1">ENCUESTAS ACTIVAS</p>
                                        <h2 class="fw-bold mb-0 text-warning" id="stat-surveys">0</h2>
                                    </div>
                                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning"><i class="bi bi-file-text fs-4"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="results-container" class="row g-4"></div>
                </div>

                <!-- 2. PARTICIPANTES -->
                <div id="admin-participants" class="admin-section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="fw-bold m-0">Gestión de Participantes</h2>
                        <div id="db-status" class="badge bg-secondary"><i class="bi bi-hdd-network"></i> Modo Local</div>
                    </div>

                    <div class="card p-4 border-top border-4 border-primary mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold m-0" id="form-p-title"><i class="bi bi-person-plus-fill me-2"></i>Registrar Nuevo Participante</h5>
                            <button id="btn-cancel-edit-p" onclick="app.clearParticipantForm()" class="btn btn-sm btn-link text-muted d-none">Cancelar Edición</button>
                        </div>
                        
                        <form id="form-participant" onsubmit="app.handleSaveParticipant(event)">
                            <input type="hidden" id="p-original-email">
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label small fw-bold text-muted">CORREO ELECTRÓNICO</label><input type="email" id="p-email" class="form-control" required placeholder="ej. usuario@empresa.com"></div>
                                <div class="col-md-3"><label class="form-label small fw-bold text-muted">NOMBRE</label><input type="text" id="p-nombre" class="form-control" required></div>
                                <div class="col-md-3"><label class="form-label small fw-bold text-muted">APELLIDO</label><input type="text" id="p-apellido" class="form-control"></div>
                                <div class="col-md-3"><label class="form-label small fw-bold text-muted">SEXO</label><div class="d-flex gap-3 pt-2"><div class="form-check"><input class="form-check-input" type="radio" name="p-sexo" id="sexoM" value="Masculino" checked><label class="form-check-label" for="sexoM">Masculino</label></div><div class="form-check"><input class="form-check-input" type="radio" name="p-sexo" id="sexoF" value="Femenino"><label class="form-check-label" for="sexoF">Femenino</label></div></div></div>
                                <div class="col-md-3"><label class="form-label small fw-bold text-muted">NACIONALIDAD</label><select id="p-nacionalidad" class="form-select"><option value="República Dominicana">República Dominicana</option><option value="México">México</option><option value="Colombia">Colombia</option><option value="Estados Unidos">Estados Unidos</option><option value="Otro">Otro</option></select></div>
                                <div class="col-md-3"><label class="form-label small fw-bold text-muted">EDAD</label><input type="number" id="p-edad" class="form-control" placeholder="Ej. 30"></div>
                                <div class="col-md-3"><label class="form-label small fw-bold text-muted">FECHA NACIMIENTO</label><input type="date" id="p-fecha" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small fw-bold text-muted">CIUDAD</label><input type="text" id="p-ciudad" class="form-control" value="Santo Domingo"></div>
                                <div class="col-md-4"><label class="form-label small fw-bold text-muted">DIRECCIÓN</label><input type="text" id="p-direccion" class="form-control" placeholder="Calle, Número..."></div>
                                <div class="col-md-4"><label class="form-label small fw-bold text-muted">TELÉFONO</label><input type="tel" id="p-telefono" class="form-control" placeholder="+1 809..."></div>
                            </div>
                            <div class="mt-4 text-end"><button type="submit" id="btn-save-p" class="btn btn-primary px-4 fw-bold"><i class="bi bi-save"></i> Guardar Participante</button></div>
                        </form>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center py-3">
                            <span>Listado de Participantes</span>
                            <span class="badge bg-light text-dark border" id="p-count">0 registros</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light"><tr><th>Usuario</th><th>Perfil</th><th>Ubicación</th><th class="text-end">Acciones</th></tr></thead>
                                <tbody id="table-participants-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. ENCUESTAS -->
                <div id="admin-surveys" class="admin-section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="fw-bold m-0">Configuración de Encuestas</h2>
                        <button onclick="app.showSurveyForm()" class="btn btn-primary"><i class="bi bi-plus-lg"></i> Crear Nueva</button>
                    </div>

                    <div id="surveys-list-container"></div>

                    <div id="survey-form-container" class="d-none">
                        <div class="row g-4">
                            <div class="col-lg-8">
                                <div class="card p-4 border-top border-4 border-primary h-100">
                                    <div class="d-flex justify-content-between mb-4">
                                        <h4 class="fw-bold">Editor de Encuesta</h4>
                                        <input type="hidden" id="s-id">
                                    </div>
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-4"><label class="form-label small fw-bold">TIPO</label><select id="s-type" class="form-select" onchange="app.updateCategories()"><option value="Politica">Política</option><option value="Comercial">Comercial</option><option value="Otros">Otros</option></select></div>
                                        <div class="col-md-8"><label class="form-label small fw-bold">TÍTULO GENERAL</label><input type="text" id="s-title" class="form-control" placeholder="Ej. Elecciones 2025" autofocus></div>
                                    </div>
                                    <div class="bg-light p-3 rounded border">
                                        <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-plus-circle"></i> Agregar Pregunta / Cargo</h6>
                                        <div class="row g-2">
                                            <div class="col-md-4"><select id="q-category" class="form-select form-select-sm"></select></div>
                                            <div class="col-md-8"><input type="text" id="q-title" class="form-control form-select-sm" placeholder="Título de la pregunta"></div>
                                            <div class="col-12"><input type="text" id="q-options" class="form-control form-select-sm" placeholder="Opciones separadas por coma (A, B, C...)"></div>
                                            <div class="col-12 text-end mt-2"><button onclick="app.addDraftQuestion()" class="btn btn-dark btn-sm px-3">Agregar a la lista</button></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card h-100">
                                    <div class="card-header bg-white fw-bold py-3">Estructura Actual</div>
                                    <div class="card-body overflow-auto bg-light" id="draft-questions-list" style="max-height: 400px; min-height: 200px;"><div class="text-center text-muted mt-5 small">Agrega preguntas...</div></div>
                                    <div class="card-footer bg-white p-3">
                                        <button onclick="app.saveSurvey()" class="btn btn-success w-100 fw-bold mb-2"><i class="bi bi-check-lg"></i> Guardar Todo</button>
                                        <button onclick="app.hideSurveyForm()" class="btn btn-outline-secondary w-100 btn-sm">Cancelar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. INVITACIONES -->
                <div id="admin-invites" class="admin-section d-none">
                    <h2 class="fw-bold mb-4">Centro de Invitaciones</h2>
                    <div class="card p-3 mb-4 border-start border-4 border-info">
                        <div class="row align-items-center">
                            <div class="col-md-8"><input type="text" id="invite-search" class="form-control" placeholder="Buscar participante para enviar link..." onkeyup="app.renderInvites()"></div>
                            <div class="col-md-4 text-md-end mt-2 mt-md-0"><small class="text-muted"><i class="bi bi-info-circle"></i> Envía credenciales seguras</small></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light"><tr><th>Participante</th><th>Estado Voto</th><th class="text-end">Herramientas</th></tr></thead>
                                <tbody id="table-invites-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ================= VISTA: LANDING ================= -->
    <div id="view-landing" class="view-section active">
        <div class="container d-flex justify-content-center align-items-center min-vh-100">
            <div class="card shadow-lg p-4 border-0" style="max-width: 450px; width: 100%;">
                <div class="text-center mb-4">
                    <i class="bi bi-box-seam-fill text-primary display-4"></i>
                    <h2 class="fw-bold mt-2">Acceso a Votación</h2>
                    <p class="text-muted small">Ingrese sus credenciales para acceder a la boleta</p>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">CORREO ELECTRÓNICO</label>
                    <input type="email" id="login-email" class="form-control" placeholder="usuario@correo.com">
                </div>
                <div id="login-error" class="alert alert-danger d-none py-2 small mb-3"></div>
                <button onclick="app.handleLogin()" class="btn btn-primary w-100 py-2 fw-bold mb-3">Entrar a la Urna</button>
                <button onclick="app.adminRouter('dashboard')" class="btn btn-link text-muted w-100 btn-sm text-decoration-none">Acceso Administrativo</button>
            </div>
        </div>
    </div>

    <!-- ================= VISTA: VOTING BOOTH ================= -->
    <div id="view-voting" class="view-section">
        <div class="container py-5" style="max-width: 800px;">
            <div class="d-flex justify-content-between align-items-center mb-5 pb-3 border-bottom">
                <div>
                    <h2 class="fw-bold m-0">Boleta Electoral</h2>
                    <div class="text-muted small">Votando como: <span id="voter-display" class="fw-bold text-dark"></span></div>
                </div>
                <span class="badge bg-success rounded-pill px-3 py-2"><i class="bi bi-shield-lock"></i> VOTO SECRETO</span>
            </div>
            <div id="voting-container"></div>
            <div class="d-flex gap-3 mt-5 pt-4 border-top">
                <button onclick="app.cancelVote()" class="btn btn-outline-secondary flex-grow-1">Cancelar</button>
                <button onclick="app.submitVote()" id="btn-submit-final" class="btn btn-primary flex-grow-1 fw-bold py-2" disabled>DEPOSITAR VOTO</button>
            </div>
        </div>
    </div>

    <!-- Modal Asignación -->
    <div class="modal fade" id="assignModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Asignar Participantes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded mb-3">
                        <span class="small fw-bold" id="assign-status">Estado: Pública</span>
                        <button onclick="app.toggleAllAssign()" class="btn btn-link btn-sm p-0 fw-bold text-decoration-none">Seleccionar Todos</button>
                    </div>
                    <div id="assign-list" class="border rounded p-2 overflow-auto" style="max-height: 300px;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" onclick="app.saveAssignments()" class="btn btn-primary btn-sm">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==========================================
        // CONFIGURACIÓN (TUS DATOS AQUÍ)
        // ==========================================
        const SUPABASE_URL = "https://fiirddumqcohrujduyij.supabase.co";
        // LLAVE ANON INSERTADA:
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpaXJkZHVtcWNvaHJ1amR1eWlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4ODgzNjksImV4cCI6MjA4MTQ2NDM2OX0.3n5cmwaHnv30UU_jlc1MsXoIOR-y0KOtOMbX4XZ3il8"; 

        // CONFIGURACIÓN EMAILJS
        const EMAILJS_PUBLIC_KEY = "H37aYCjH5v3EpiG3p"; 
        const EMAILJS_SERVICE_ID = "service_tl2wlew"; 
        const EMAILJS_TEMPLATE_ID = "template_1xqiodq"; 

        const INITIAL_DATA = {
            participants: [
                {email:"admin@test.com", nombre:"Juan", apellido:"Admin", sexo:"Masculino", edad:30, fechaNacimiento:"1993-01-01", nacionalidad:"República Dominicana", ciudad:"Santo Domingo", direccion:"Calle 1", telefono:"809-555-5555", hasVoted:false}
            ],
            surveys: [],
            votes: []
        };

        // --- SUPABASE API ---
        const supabaseApi = {
            // API COMPLETA
            async fetchAll(table) {
                try {
                    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=*`, {
                        method: 'GET',
                        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                    });
                    if(!res.ok) throw new Error(res.statusText);
                    return await res.json();
                } catch(e) { return null; }
            },
            async insert(table, data) {
                try {
                    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                        method: 'POST',
                        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(data)
                    });
                    if (!res.ok) {
                        const errBody = await res.text();
                        console.error("Supabase Error:", errBody);
                        return false;
                    }
                    return true;
                } catch(e) { 
                    console.error("Fetch Error:", e);
                    return false; 
                }
            },
            async insertParticipant(data) { return this.insert('participantes', data); },
            async getParticipants() { return this.fetchAll('participantes').then(d => ({ data: d })); },
            
            async update(table, id, data) {
                 try {
                    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(data)
                    });
                    return res.ok;
                } catch(e) { return false; }
            },
            async delete(table, id) {
                 try {
                    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
                        method: 'DELETE',
                        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                    });
                    return res.ok;
                } catch(e) { return false; }
            }
        };

        // --- APP LOGIC ---
        const app = {
            data: { participants: [], surveys: [], votes: [] },
            state: { currentUser: null, draftQuestions: [], editingId: null, assignId: null, tempAssign: new Set(), selections: {}, previousView: 'landing' },

            init: async function() {
                // 1. Cargar datos locales iniciales
                this.data.participants = JSON.parse(localStorage.getItem('e_participants')) || INITIAL_DATA.participants;
                this.data.surveys = JSON.parse(localStorage.getItem('e_surveys')) || INITIAL_DATA.surveys;
                this.data.votes = JSON.parse(localStorage.getItem('e_votes')) || INITIAL_DATA.votes;
                
                // 2. Init EmailJS
                if(window.emailjs) {
                    emailjs.init(EMAILJS_PUBLIC_KEY);
                    console.log("EmailJS iniciado");
                }

                // 3. Supabase Status Check
                if(SUPABASE_KEY.startsWith("ey")) {
                    const statusEl = document.getElementById('db-status');
                    if(statusEl) {
                        statusEl.className = "badge bg-success";
                        statusEl.innerHTML = '<i class="bi bi-cloud-check"></i> Conectado';
                    }
                    
                    await this.syncData(); // Cargar todo al inicio
                }
                
                this.save(); 

                // 4. LÓGICA DE RUTEO INICIAL
                const params = new URLSearchParams(window.location.search);
                const userLink = params.get('user');

                if (userLink) {
                    // Si hay link, intentar login directo a votación
                    document.getElementById('loading-overlay').classList.remove('d-none');
                    // Pequeño delay para asegurar carga
                    setTimeout(() => {
                        this.handleLogin(userLink, false);
                        document.getElementById('loading-overlay').classList.add('d-none');
                    }, 800);
                } else {
                    // Si NO hay link, ir a Landing (Login) por defecto para seguridad
                    this.router('landing');
                }
            },
            
            // Función para sincronizar TODO desde la nube
            syncData: async function() {
                const p = await supabaseApi.fetchAll('participantes');
                if(p) this.data.participants = p;
                
                const s = await supabaseApi.fetchAll('encuestas');
                if(s) this.data.surveys = s;
                
                // Si existe tabla votos en DB, cargarla. Si no, usamos local.
                const v = await supabaseApi.fetchAll('votos');
                if(v && v.length >= 0) this.data.votes = v;
                
                this.save();
                this.renderDashboard(); 
            },

            save: function() {
                localStorage.setItem('e_participants', JSON.stringify(this.data.participants));
                localStorage.setItem('e_surveys', JSON.stringify(this.data.surveys));
                localStorage.setItem('e_votes', JSON.stringify(this.data.votes));
            },

            router: function(view) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${view}`).classList.add('active');
                if(view === 'landing') {
                    document.getElementById('login-email').value = '';
                    document.getElementById('login-error').classList.add('d-none');
                }
            },

            adminRouter: function(subView) {
                this.router('admin');
                document.querySelectorAll('.admin-section').forEach(el => el.classList.add('d-none'));
                document.getElementById(`admin-${subView}`).classList.remove('d-none');
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                document.getElementById(`nav-${subView}`).classList.add('active');

                if(subView === 'dashboard') this.renderDashboard();
                if(subView === 'participants') this.renderParticipants();
                if(subView === 'surveys') this.renderSurveys();
                if(subView === 'invites') this.renderInvites();
            },

            goToLanding: function() { this.router('landing'); },

            // --- PARTICIPANTES ---
            handleSaveParticipant: async function(e) {
                e.preventDefault();
                const email = document.getElementById('p-email').value;
                const originalEmail = document.getElementById('p-original-email').value;
                const pData = {
                    email: email, nombre: document.getElementById('p-nombre').value, apellido: document.getElementById('p-apellido').value,
                    sexo: document.querySelector('input[name="p-sexo"]:checked').value, nacionalidad: document.getElementById('p-nacionalidad').value,
                    edad: document.getElementById('p-edad').value, fechaNacimiento: document.getElementById('p-fecha').value,
                    ciudad: document.getElementById('p-ciudad').value, direccion: document.getElementById('p-direccion').value,
                    telefono: document.getElementById('p-telefono').value, hasVoted: false
                };

                if (originalEmail) { // Update
                     const localP = this.data.participants.find(x => x.email === originalEmail);
                     if(localP && localP.id) await supabaseApi.update('participantes', localP.id, pData);
                     const idx = this.data.participants.findIndex(x => x.email === originalEmail);
                     this.data.participants[idx] = { ...this.data.participants[idx], ...pData };
                     alert("Actualizado");
                } else { // Create
                    if(this.data.participants.find(x => x.email === email)) return alert("Correo ya existe");
                    await supabaseApi.insert('participantes', pData);
                    const fresh = await supabaseApi.fetchAll('participantes'); // Re-fetch to get IDs
                    if(fresh) this.data.participants = fresh; else this.data.participants.push(pData);
                    alert("Registrado");
                }
                this.save();
                this.clearParticipantForm();
                this.renderParticipants();
            },
            
            editParticipant: function(email) {
                const p = this.data.participants.find(x => x.email === email);
                document.getElementById('p-email').value = p.email;
                document.getElementById('p-email').disabled = true;
                document.getElementById('p-original-email').value = p.email;
                document.getElementById('p-nombre').value = p.nombre;
                document.getElementById('p-apellido').value = p.apellido;
                document.querySelector(`input[name="p-sexo"][value="${p.sexo}"]`).checked = true;
                document.getElementById('p-nacionalidad').value = p.nacionalidad;
                document.getElementById('p-edad').value = p.edad;
                document.getElementById('p-fecha').value = p.fechaNacimiento;
                document.getElementById('p-ciudad').value = p.ciudad;
                document.getElementById('p-direccion').value = p.direccion;
                document.getElementById('p-telefono').value = p.telefono;
                document.getElementById('form-p-title').innerHTML = "Editar Participante";
                document.getElementById('btn-save-p').innerHTML = "Actualizar";
                document.getElementById('btn-cancel-edit-p').classList.remove('d-none');
                window.scrollTo({top:0, behavior:'smooth'});
            },
            
            deleteParticipant: async function(email) {
                if(confirm("¿Eliminar?")) {
                    const p = this.data.participants.find(x => x.email === email);
                    if(p && p.id) await supabaseApi.delete('participantes', p.id);
                    this.data.participants = this.data.participants.filter(x => x.email !== email);
                    this.save();
                    this.renderParticipants();
                }
            },
            
            clearParticipantForm: function() {
                document.getElementById('form-participant').reset();
                document.getElementById('p-email').disabled = false;
                document.getElementById('p-original-email').value = "";
                document.getElementById('form-p-title').innerHTML = '<i class="bi bi-person-plus-fill me-2"></i>Registrar Nuevo Participante';
                document.getElementById('btn-save-p').innerHTML = '<i class="bi bi-save"></i> Guardar Participante';
                document.getElementById('btn-cancel-edit-p').classList.add('d-none');
            },
            
            renderParticipants: function() {
                const tbody = document.getElementById('table-participants-body');
                tbody.innerHTML = '';
                document.getElementById('p-count').innerText = `${this.data.participants.length} registros`;
                this.data.participants.forEach(p => {
                    tbody.innerHTML += `<tr><td><div class="fw-bold text-dark">${p.nombre} ${p.apellido||''}</div><div class="small text-primary">${p.email}</div></td><td class="small text-muted"><div>${p.sexo} • ${p.edad||'?'} años</div><div>${p.nacionalidad}</div></td><td class="small text-muted"><div>${p.ciudad}</div><div class="text-truncate" style="max-width:150px">${p.direccion||''}</div></td><td class="text-end"><button onclick="app.editParticipant('${p.email}')" class="btn btn-sm btn-outline-secondary me-1"><i class="bi bi-pencil"></i></button><button onclick="app.deleteParticipant('${p.email}')" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button></td></tr>`;
                });
            },

            // --- SURVEYS ---
            saveSurvey: async function() {
                const title = document.getElementById('s-title').value;
                if(!title) return alert("Falta título");
                
                let existingAllowed = [];
                if(this.state.editingId) {
                    const existingS = this.data.surveys.find(s => s.id == this.state.editingId);
                    if(existingS) existingAllowed = existingS.allowedEmails || [];
                }

                const sData = {
                    title: title,
                    type: document.getElementById('s-type').value,
                    questions: this.state.draftQuestions,
                    allowedEmails: existingAllowed 
                };

                if(this.state.editingId) {
                     await supabaseApi.update('encuestas', this.state.editingId, sData);
                     alert("Encuesta actualizada");
                } else {
                     await supabaseApi.insert('encuestas', sData);
                     alert("Encuesta creada");
                }

                const s = await supabaseApi.fetchAll('encuestas');
                if(s) this.data.surveys = s;
                this.save();
                this.hideSurveyForm();
                this.renderSurveys();
            },

            deleteSurvey: async function(id) {
                if(confirm("¿Borrar?")) {
                    await supabaseApi.delete('encuestas', id);
                    this.data.surveys = this.data.surveys.filter(x => x.id != id);
                    this.save();
                    this.renderSurveys();
                }
            },

            // ... (show/hide/updateCategories/addDraft/renderDraft/editSurvey/renderSurveys - mismo que antes) ...
            renderSurveys: function() {
                const c = document.getElementById('surveys-list-container');
                c.innerHTML = '';
                this.data.surveys.forEach(s => {
                    const assigned = s.allowedEmails ? s.allowedEmails.length : 0;
                    const badge = assigned === 0 ? '<span class="badge bg-success">Pública</span>' : `<span class="badge bg-warning text-dark">Privada (${assigned})</span>`;
                    c.innerHTML += `<div class="card survey-card p-3 ${s.type.toLowerCase()}"><div class="d-flex justify-content-between"><div><h5 class="fw-bold">${s.title}</h5><span class="badge bg-light text-dark border">${s.type}</span> ${badge}</div><div><button onclick="app.openAssignModal(${s.id})" class="btn btn-sm btn-outline-dark me-1"><i class="bi bi-person-check"></i></button><button onclick="app.editSurvey(${s.id})" class="btn btn-sm btn-outline-primary me-1"><i class="bi bi-pencil"></i></button><button onclick="app.deleteSurvey(${s.id})" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button></div></div></div>`;
                });
            },
            showSurveyForm: function() { document.getElementById('surveys-list-container').classList.add('d-none'); document.getElementById('survey-form-container').classList.remove('d-none'); this.state.draftQuestions = []; this.state.editingId = null; },
            hideSurveyForm: function() { document.getElementById('surveys-list-container').classList.remove('d-none'); document.getElementById('survey-form-container').classList.add('d-none'); },
            addDraftQuestion: function() { const t = document.getElementById('q-title').value; const o = document.getElementById('q-options').value; if(!t) return; let arr = o.split(',').map(x=>x.trim()).filter(Boolean); if(arr.length===0) arr=["Si","No"]; if(!arr.includes("No sé")) arr.push("No sé"); if(!arr.includes("Ninguno")) arr.push("Ninguno"); this.state.draftQuestions.push({id: Date.now(), title: t, category: document.getElementById('q-category').value, options: arr}); this.renderDraftQ(); document.getElementById('q-title').value=''; },
            renderDraftQ: function() { document.getElementById('draft-questions-list').innerHTML = this.state.draftQuestions.map((q,i)=>`<div class="border-bottom mb-2 position-relative"><button onclick="app.removeDraftQ(${i})" class="btn btn-link text-danger position-absolute top-0 end-0 p-0"><i class="bi bi-x"></i></button><b>${q.title}</b><br><small>${q.options.join(', ')}</small></div>`).join(''); },
            removeDraftQ: function(i) { this.state.draftQuestions.splice(i,1); this.renderDraftQ(); },
            updateCategories: function() { const type = document.getElementById('s-type').value; const sel = document.getElementById('q-category'); sel.innerHTML = ''; const cats = type === 'Politica' ? ["Elección Popular", "Referéndum"] : ["General", "Satisfacción"]; cats.forEach(c => { const o = document.createElement('option'); o.value=c; o.text=c; sel.add(o); }); },
            editSurvey: function(id) { const s = this.data.surveys.find(x => x.id == id); this.showSurveyForm(); this.state.editingId = id; document.getElementById('s-title').value = s.title; document.getElementById('s-type').value = s.type; this.state.draftQuestions = [...s.questions]; this.renderDraftQ(); this.updateCategories(); },

            // --- ASIGNACIONES (CORREGIDO PARA SUPABASE) ---
            openAssignModal: function(id) {
                this.state.assignId = id;
                const s = this.data.surveys.find(x => x.id == id);
                this.state.tempAssign = new Set(s.allowedEmails || []);
                this.renderAssignList();
                new bootstrap.Modal(document.getElementById('assignModal')).show();
            },

            renderAssignList: function() {
                const c = document.getElementById('assign-list');
                const isPublic = this.state.tempAssign.size === 0;
                document.getElementById('assign-status').innerHTML = isPublic ? '<span class="text-success">Pública</span>' : `<span class="text-warning">Privada (${this.state.tempAssign.size})</span>`;
                c.innerHTML = '';
                this.data.participants.forEach(p => {
                    const div = document.createElement('div');
                    const checked = this.state.tempAssign.has(p.email) ? 'checked' : '';
                    div.className = 'form-check border-bottom py-2';
                    div.innerHTML = `<input class="form-check-input" type="checkbox" ${checked} onchange="app.toggleAssign('${p.email}')"><label class="form-check-label w-100"><span class="fw-bold">${p.nombre} ${p.apellido||''}</span><br><small class="text-muted">${p.email}</small></label>`;
                    c.appendChild(div);
                });
            },

            toggleAssign: function(email) {
                if(this.state.tempAssign.has(email)) this.state.tempAssign.delete(email);
                else this.state.tempAssign.add(email);
                this.renderAssignList();
            },

            toggleAllAssign: function() {
                if(this.state.tempAssign.size === this.data.participants.length) this.state.tempAssign.clear();
                else this.data.participants.forEach(p => this.state.tempAssign.add(p.email));
                this.renderAssignList();
            },

            saveAssignments: async function() {
                const idx = this.data.surveys.findIndex(s => s.id == this.state.assignId);
                const newAllowed = Array.from(this.state.tempAssign);
                
                // Update Supabase (CORREGIDO)
                await supabaseApi.update('encuestas', this.state.assignId, { allowedEmails: newAllowed });
                
                // Update Local
                this.data.surveys[idx].allowedEmails = newAllowed;
                this.save();
                this.renderSurveys();
                bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
                alert("Asignación guardada");
            },

            // --- INVITES (Re-implementado correctamente) ---
            renderInvites: function() {
                const term = document.getElementById('invite-search').value.toLowerCase();
                const tbody = document.getElementById('table-invites-body');
                tbody.innerHTML = '';
                this.data.participants.filter(p=>p.email.toLowerCase().includes(term)).forEach(p => {
                    const badge = p.hasVoted ? '<span class="badge bg-secondary">Votó</span>' : '<span class="badge bg-success">Pendiente</span>';
                    let btns = !p.hasVoted ? `<button onclick="app.copyLink('${p.email}')" class="btn btn-sm btn-outline-secondary me-1"><i class="bi bi-link-45deg"></i></button><button onclick="app.sendEmail('${p.email}', this)" class="btn btn-sm btn-primary me-1"><i class="bi bi-envelope"></i></button><button onclick="app.handleLogin('${p.email}', true)" class="btn btn-sm btn-warning"><i class="bi bi-play-circle"></i></button>` : '';
                    tbody.innerHTML += `<tr><td><div class="fw-bold">${p.nombre}</div><div class="small">${p.email}</div></td><td>${badge}</td><td class="text-end">${btns}</td></tr>`;
                });
            },

            copyLink: function(email) {
                const url = `${window.location.href.split('?')[0]}?user=${encodeURIComponent(email)}`;
                navigator.clipboard.writeText(url).then(()=>alert("Link copiado"));
            },

            sendEmail: function(email, btn) {
                const url = `${window.location.href.split('?')[0]}?user=${encodeURIComponent(email)}`;
                const user = this.data.participants.find(p => p.email === email);
                const name = user ? user.nombre : 'Usuario';
                
                if(window.emailjs) {
                    btn.innerHTML = '...';
                    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, { to_email: email, to_name: name, link_voto: url })
                    .then(() => { alert("Enviado"); btn.innerHTML = '<i class="bi bi-check"></i>'; });
                } else {
                    window.location.href = `mailto:${email}?body=${url}`;
                }
            },

            // ... (Resto de funciones: handleLogin, renderVotingBooth, select, submitVote, cancelVote, resetSystem igual que antes) ...
            handleLogin: function(input, fromAdmin) {
                const email = input || document.getElementById('login-email').value;
                if(!email) return;
                const user = this.data.participants.find(p => p.email.toLowerCase() === email.toLowerCase());
                if(!user) return alert("Correo no encontrado");
                if(user.hasVoted) return alert("Ya votaste");
                this.state.currentUser = user;
                this.state.previousView = fromAdmin ? 'admin' : 'landing';
                this.router('voting');
                this.renderVotingBooth();
            },
            
            renderVotingBooth: function() {
                document.getElementById('voter-display').textContent = this.state.currentUser.email;
                const c = document.getElementById('voting-container');
                c.innerHTML = '';
                this.state.selections = {};
                
                const visible = this.data.surveys.filter(s => !s.allowedEmails || s.allowedEmails.length===0 || s.allowedEmails.includes(this.state.currentUser.email));
                if(visible.length === 0) { c.innerHTML = "No hay encuestas disponibles."; return; }

                visible.forEach(s => {
                    const qs = s.questions.map(q => {
                        const opts = q.options.map(o => `<div class="form-check"><input class="form-check-input" type="radio" name="q-${q.id}" onchange="app.select('${q.id}','${o}')"><label class="form-check-label">${o}</label></div>`).join('');
                        return `<div class="card p-3 mb-3"><h6>${q.title}</h6>${opts}</div>`;
                    }).join('');
                    c.innerHTML += `<h5 class="mt-4">${s.title}</h5>${qs}`;
                });
            },
            
            select: function(qid, opt) { 
                this.state.selections[qid] = opt; 
                document.getElementById('btn-submit-final').disabled = false; 
            },
            
            submitVote: async function() {
                // Disable button to prevent double submission
                document.getElementById('btn-submit-final').disabled = true;
                document.getElementById('btn-submit-final').innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';

                try {
                    const votePromises = Object.entries(this.state.selections).map(([qid, opt]) => {
                        return supabaseApi.insert('votos', { 
                            questionId: qid, 
                            option: opt, 
                            voterEmail: this.state.currentUser.email 
                        });
                    });

                    // Wait for all votes to be stored
                    const results = await Promise.all(votePromises);
                    
                    // Check if any failed
                    const allSuccess = results.every(r => r === true);

                    if (!allSuccess) {
                        throw new Error("Error al guardar algunos votos en la nube.");
                    }

                    // Update participant status
                    if(this.state.currentUser.id) {
                        await supabaseApi.update('participantes', this.state.currentUser.id, {hasVoted: true});
                    }

                    // Update local
                    const idx = this.data.participants.findIndex(p => p.email === this.state.currentUser.email);
                    if(idx !== -1) this.data.participants[idx].hasVoted = true;
                    
                    await this.syncData(); 
                    alert("Voto depositado correctamente. Gracias por su participación.");
                    this.router('landing');

                } catch (error) {
                    console.error(error);
                    alert("Hubo un problema registrando el voto. Por favor intente de nuevo.");
                    document.getElementById('btn-submit-final').disabled = false;
                    document.getElementById('btn-submit-final').innerHTML = 'DEPOSITAR VOTO';
                }
            },
            
            cancelVote: function() { this.state.currentUser = null; this.router(this.state.previousView); },
            renderDashboard: function() {
                document.getElementById('stat-total').innerText = this.data.participants.length;
                document.getElementById('stat-surveys').innerText = this.data.surveys.length;
                const uniqueVotes = new Set(this.data.votes.map(v => v.voterEmail)).size;
                document.getElementById('stat-votes').innerText = uniqueVotes;
                const container = document.getElementById('results-container');
                container.innerHTML = '';
                this.data.surveys.forEach(s => {
                    let qHtml = '';
                    s.questions.forEach(q => {
                        const qVotes = this.data.votes.filter(v => v.questionId == q.id);
                        const counts = {};
                        q.options.forEach(o => counts[o] = 0);
                        qVotes.forEach(v => { if(counts[v.option] !== undefined) counts[v.option]++ });
                        let bars = '';
                        q.options.forEach(opt => {
                            const val = counts[opt];
                            const pct = qVotes.length ? Math.round((val / qVotes.length)*100) : 0;
                            bars += `<div class="mb-2"><div class="d-flex justify-content-between small mb-1"><span>${opt}</span><span class="fw-bold">${val} (${pct}%)</span></div><div class="progress" style="height: 8px;"><div class="progress-bar" style="width:${pct}%"></div></div></div>`;
                        });
                        qHtml += `<div class="col-md-6 mb-3"><div class="card p-3 h-100 border"><div class="badge bg-light text-secondary mb-2 w-auto align-self-start border">${q.category}</div><h6 class="fw-bold">${q.title}</h6>${bars}<small class="text-end text-muted mt-2 d-block">${qVotes.length} votos</small></div></div>`;
                    });
                    const card = document.createElement('div');
                    card.className = 'col-12';
                    card.innerHTML = `<div class="card bg-white p-3"><h4 class="text-primary border-bottom pb-2 mb-3"><i class="bi bi-folder2-open"></i> ${s.title}</h4><div class="row">${qHtml}</div></div>`;
                    container.appendChild(card);
                });
            },
            resetSystem: function() { if(confirm("Reset?")) { localStorage.clear(); window.location.reload(); } }
        };
        
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>