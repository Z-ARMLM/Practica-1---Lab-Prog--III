<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Encuestas</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Supabase JS (Opcional, listo para usar) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="loading-overlay" class="d-none">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 fw-bold text-muted">Cargando plataforma...</p>
    </div>

    <div id="view-admin" class="view-section">
        <div class="d-flex flex-column flex-lg-row">
            <div class="sidebar p-3 d-flex flex-column" style="width: 280px; flex-shrink: 0;">
                <div class="d-flex align-items-center mb-4 px-2 py-2">
                    <div class="bg-primary text-white rounded p-2 me-2"><i class="bi bi-box-seam-fill"></i></div>
                    <span class="fs-5 fw-bold text-dark">Plataforma</span>
                </div>
                
                <ul class="nav flex-column mb-auto">
                    <li><a href="#" onclick="app.adminRouter('dashboard')" class="nav-link active" id="nav-dashboard"><i class="bi bi-bar-chart-line"></i> Resultados</a></li>
                    <li><a href="#" onclick="app.adminRouter('participants')" class="nav-link" id="nav-participants"><i class="bi bi-people"></i> Participantes</a></li>
                    <li><a href="#" onclick="app.adminRouter('surveys')" class="nav-link" id="nav-surveys"><i class="bi bi-file-earmark-text"></i> Encuestas</a></li>
                    <li><a href="#" onclick="app.adminRouter('invites')" class="nav-link" id="nav-invites"><i class="bi bi-send"></i> Invitaciones</a></li>
                </ul>
                
                <div class="mt-auto pt-4 border-top">
                    <button onclick="window.location.href = window.location.pathname" class="btn btn-outline-danger w-100 btn-sm mb-2"><i class="bi bi-box-arrow-left"></i> Cerrar Sesión</button>
                </div>
            </div>

            <div class="flex-fill p-4 bg-light overflow-auto" style="height: 100vh;">
                
                <div id="admin-dashboard" class="admin-section">
                    <h2 class="fw-bold mb-4 text-dark">Panel de Resultados</h2>
                    
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1">TOTAL PARTICIPANTES</p>
                                        <h2 class="fw-bold mb-0" id="stat-total">0</h2>
                                    </div>
                                    <div class="bg-soft-primary p-3 rounded-circle text-primary bg-opacity-10"><i class="bi bi-people fs-4"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1">VOTOS RECIBIDOS</p>
                                        <h2 class="fw-bold mb-0 text-success" id="stat-votes">0</h2>
                                    </div>
                                    <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success"><i class="bi bi-check-lg fs-4"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1">ENCUESTAS ACTIVAS</p>
                                        <h2 class="fw-bold mb-0 text-warning" id="stat-surveys">0</h2>
                                    </div>
                                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning"><i class="bi bi-file-text fs-4"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="results-container" class="row g-4"></div>
                </div>

                <div id="admin-participants" class="admin-section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="fw-bold m-0">Gestión de Participantes</h2>
                        <div id="db-status" class="badge bg-secondary"><i class="bi bi-hdd-network"></i> Modo Local</div>
                    </div>

                    <div class="card p-4 border-top border-4 border-primary mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold m-0" id="form-p-title"><i class="bi bi-person-plus-fill me-2"></i>Registrar Nuevo Participante</h5>
                            <button id="btn-cancel-edit-p" onclick="app.clearParticipantForm()" class="btn btn-sm btn-link text-muted d-none">Cancelar Edición</button>
                        </div>
                        
                        <form id="form-participant" onsubmit="app.handleSaveParticipant(event)">
                            <input type="hidden" id="p-original-email">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">CORREO ELECTRÓNICO</label>
                                    <input type="email" id="p-email" class="form-control" required placeholder="ej. usuario@empresa.com">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold text-muted">NOMBRE</label>
                                    <input type="text" id="p-nombre" class="form-control" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold text-muted">APELLIDO</label>
                                    <input type="text" id="p-apellido" class="form-control">
                                </div>
                                
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold text-muted">SEXO</label>
                                    <div class="d-flex gap-3 pt-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="p-sexo" id="sexoM" value="Masculino" checked>
                                            <label class="form-check-label" for="sexoM">Masculino</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="p-sexo" id="sexoF" value="Femenino">
                                            <label class="form-check-label" for="sexoF">Femenino</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold text-muted">NACIONALIDAD</label>
                                    <select id="p-nacionalidad" class="form-select">
                                        <option value="República Dominicana">República Dominicana</option>
                                        <option value="México">México</option>
                                        <option value="Colombia">Colombia</option>
                                        <option value="Estados Unidos">Estados Unidos</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold text-muted">EDAD</label>
                                    <input type="number" id="p-edad" class="form-control" placeholder="Ej. 30">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold text-muted">FECHA NACIMIENTO</label>
                                    <input type="date" id="p-fecha" class="form-control">
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label small fw-bold text-muted">CIUDAD</label>
                                    <input type="text" id="p-ciudad" class="form-control" value="Santo Domingo">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold text-muted">DIRECCIÓN</label>
                                    <input type="text" id="p-direccion" class="form-control" placeholder="Calle, Número...">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold text-muted">TELÉFONO</label>
                                    <input type="tel" id="p-telefono" class="form-control" placeholder="+1 809...">
                                </div>
                            </div>
                            <div class="mt-4 text-end">
                                <button type="submit" id="btn-save-p" class="btn btn-primary px-4 fw-bold"><i class="bi bi-save"></i> Guardar Participante</button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center py-3">
                            <span>Listado de Participantes</span>
                            <span class="badge bg-light text-dark border" id="p-count">0 registros</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Perfil</th>
                                        <th>Ubicación</th>
                                        <th class="text-end">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-participants-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="admin-surveys" class="admin-section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="fw-bold m-0">Configuración de Encuestas</h2>
                        <button onclick="app.showSurveyForm()" class="btn btn-primary"><i class="bi bi-plus-lg"></i> Crear Nueva</button>
                    </div>

                    <div id="surveys-list-container"></div>

                    <div id="survey-form-container" class="d-none">
                        <div class="row g-4">
                            <div class="col-lg-8">
                                <div class="card p-4 border-top border-4 border-primary h-100">
                                    <div class="d-flex justify-content-between mb-4">
                                        <h4 class="fw-bold">Editor de Encuesta</h4>
                                        <input type="hidden" id="s-id">
                                    </div>
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold">TIPO</label>
                                            <select id="s-type" class="form-select" onchange="app.updateCategories()">
                                                <option value="Politica">Política</option>
                                                <option value="Comercial">Comercial</option>
                                                <option value="Otros">Otros</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label small fw-bold">TÍTULO GENERAL</label>
                                            <input type="text" id="s-title" class="form-control" placeholder="Ej. Elecciones 2025" autofocus>
                                        </div>
                                    </div>
                                    <div class="bg-light p-3 rounded border">
                                        <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-plus-circle"></i> Agregar Pregunta / Cargo</h6>
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <select id="q-category" class="form-select form-select-sm"></select>
                                            </div>
                                            <div class="col-md-8">
                                                <input type="text" id="q-title" class="form-control form-select-sm" placeholder="Título de la pregunta">
                                            </div>
                                            <div class="col-12">
                                                <input type="text" id="q-options" class="form-control form-select-sm" placeholder="Opciones separadas por coma (A, B, C...)">
                                            </div>
                                            <div class="col-12 text-end mt-2">
                                                <button onclick="app.addDraftQuestion()" class="btn btn-dark btn-sm px-3">Agregar a la lista</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card h-100">
                                    <div class="card-header bg-white fw-bold py-3">Estructura Actual</div>
                                    <div class="card-body overflow-auto bg-light" id="draft-questions-list" style="max-height: 400px; min-height: 200px;">
                                        <div class="text-center text-muted mt-5 small">Agrega preguntas...</div>
                                    </div>
                                    <div class="card-footer bg-white p-3">
                                        <button onclick="app.saveSurvey()" class="btn btn-success w-100 fw-bold mb-2"><i class="bi bi-check-lg"></i> Guardar Todo</button>
                                        <button onclick="app.hideSurveyForm()" class="btn btn-outline-secondary w-100 btn-sm">Cancelar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="admin-invites" class="admin-section d-none">
                    <h2 class="fw-bold mb-4">Centro de Invitaciones</h2>
                    <div class="card p-3 mb-4 border-start border-4 border-info">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <input type="text" id="invite-search" class="form-control" placeholder="Buscar participante para enviar link..." onkeyup="app.renderInvites()">
                            </div>
                            <div class="col-md-4 text-md-end mt-2 mt-md-0">
                                <small class="text-muted"><i class="bi bi-info-circle"></i> Envía credenciales seguras</small>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Participante</th>
                                        <th>Estado Voto</th>
                                        <th class="text-end">Herramientas</th>
                                    </tr>
                                </thead>
                                <tbody id="table-invites-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ================= vista general al cargar ================= -->
    <div id="view-landing" class="view-section active">
        <div class="container d-flex justify-content-center align-items-center min-vh-100">
            <div class="card shadow-lg p-4 border-0" style="max-width: 450px; width: 100%;">
                <div class="text-center mb-4">
                    <i class="bi bi-box-seam-fill text-primary display-4"></i>
                    <h2 class="fw-bold mt-2">Acceso a Votación</h2>
                    <p class="text-muted small">Ingrese sus credenciales para acceder a la boleta</p>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">CORREO ELECTRÓNICO</label>
                    <input type="email" id="login-email" class="form-control" placeholder="usuario@correo.com">
                </div>
                <div id="login-error" class="alert alert-danger d-none py-2 small mb-3"></div>
                <button onclick="app.handleLogin()" class="btn btn-primary w-100 py-2 fw-bold mb-3">Entrar a la Urna</button>
                <button onclick="app.adminRouter('dashboard')" class="btn btn-link text-muted w-100 btn-sm text-decoration-none">Acceso Administrativo</button>
            </div>
        </div>
    </div>

    <div id="view-voting" class="view-section">
        <div class="container py-5" style="max-width: 800px;">
            <div class="d-flex justify-content-between align-items-center mb-5 pb-3 border-bottom">
                <div>
                    <h2 class="fw-bold m-0">Boleta Electoral</h2>
                    <div class="text-muted small">Votando como: <span id="voter-display" class="fw-bold text-dark"></span></div>
                </div>
                <span class="badge bg-success rounded-pill px-3 py-2"><i class="bi bi-shield-lock"></i> VOTO SECRETO</span>
            </div>
            <div id="voting-container"></div>
            <div class="d-flex gap-3 mt-5 pt-4 border-top">
                <button onclick="app.cancelVote()" class="btn btn-outline-secondary flex-grow-1">Cancelar</button>
                <button onclick="app.submitVote()" id="btn-submit-final" class="btn btn-primary flex-grow-1 fw-bold py-2" disabled>DEPOSITAR VOTO</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Asignar Participantes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded mb-3">
                        <span class="small fw-bold" id="assign-status">Estado: Pública</span>
                        <button onclick="app.toggleAllAssign()" class="btn btn-link btn-sm p-0 fw-bold text-decoration-none">Seleccionar Todos</button>
                    </div>
                    <div id="assign-list" class="border rounded p-2 overflow-auto" style="max-height: 300px;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" onclick="app.saveAssignments()" class="btn btn-primary btn-sm">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
    <script src="main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>